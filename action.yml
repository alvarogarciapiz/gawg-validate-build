name: 'GAWG Validate Build'
description: 'This action belongs to the GAWG workflow and is used to validate the configurations, Dockerfile, secrets, deployment, and runner.'
author: Ãlvaro GarcÃ­a Pizarro
branding:
  icon: 'settings'
  color: 'gray-dark'

inputs:
  technology:
    type: string
    description: 'Technology to validate. For example, node, python, java, etc.'

  docker:
    type: boolean
    description: 'Flag to validate the Dockerfile.'
    default: false

  self-hosted-runner:
    type: boolean
    description: 'Flag to validate the self-hosted runner.'
    default: false

  deployment:
    type: string
    description: 'Deployment type. For example, kubernetes, helm, etc.'

outputs:
  JSON:
    description: "JSON string containing workflow config parameters from workflow_config.json."
    value: ${{ steps.generate-config.outputs.JSON }}
  VALIDATE_SUMMARY:
    description: "Summary of the validation process."
    value: ${{ steps.summary.outputs.summary }}

runs:
  using: "composite"
  steps:
    - name: GAWG Information
      shell: bash
      run: |
        echo ""
        echo "========================================= VALIDATION INFO =========================================="
        echo "This action works with the GAWG workflow and will validate configurations, Dockerfile, secrets, deployment, and runner."
        echo "If any errors are found, the action will fail. Make sure to fix them before continuing. :)"
        echo "ðŸ“¡ Technology to validate is ${{ inputs.technology }}."
        if [ "${{ inputs.docker }}" = "true" ]; then
          echo "ðŸ³ Dockerfile validation is enabled."
        else
          echo "ðŸ³ Dockerfile validation is disabled."
        fi
        if [ "${{ inputs.self-hosted-runner }}" = "true" ]; then
          echo "ðŸ  Self-hosted runner validation is enabled."
        else
          echo "ðŸ  Self-hosted runner validation is disabled."
        fi
        echo "ðŸš€ Deployment type is ${{ inputs.deployment }}."
        echo ""

    - name: Technology validation
      id: technology
      shell: bash
      run: |
        echo ""
        echo "====================================== TECHNOLOGY VALIDATION ======================================="
        if [ "${{ inputs.technology }}" = "node" ]; then
          echo "ðŸ”§ Validating Node.js configurations..."
          if [ -f "package.json" ]; then
            echo "âœ… package.json found. Validation PASSED."
          else
            echo "âŒ No package.json was found. Please add a package.json to the root of your repository."
            echo "âŒ No package.json was found. Please add a package.json to the root of your repository." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        elif [ "${{ inputs.technology }}" = "python" ]; then
          echo "ðŸ”§ Validating Python configurations..."
          if [ -f "requirements.txt" ]; then
            echo "âœ… requirements.txt found. Validation PASSED."
          else
            echo "âŒ No requirements.txt was found. Please add a requirements.txt to the root of your repository."
            echo "âŒ No requirements.txt was found. Please add a requirements.txt to the root of your repository." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        elif [ "${{ inputs.technology }}" = "java" ]; then
          echo "ðŸ”§ Validating Java configurations..."
          if [ -f "pom.xml" ]; then
            echo "âœ… pom.xml found. Validation PASSED."
          else
            echo "âŒ No pom.xml was found. Please add a pom.xml to the root of your repository."
            echo "âŒ No pom.xml was found. Please add a pom.xml to the root of your repository." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        else
          echo "âŒ Technology not supported. Please choose node, python, or java."
          echo "âŒ Technology not supported. Please choose node, python, or java." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        echo ""

    - name: Dockerfile validation
      id: dockerfile
      shell: bash
      run: |
        echo ""
        echo "======================================== DOCKER VALIDATION ========================================="
        if [ "${{ inputs.docker }}" = "true" ]; then
          if [ -f "Dockerfile" ]; then
            echo "âœ… Dockerfile found. Validation PASSED."
          else
            echo "âŒ No Dockerfile was found. Please add a Dockerfile to the root of your repository."
            echo "âŒ No Dockerfile was found. Please add a Dockerfile to the root of your repository." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        else
          echo "âœ… Dockerfile validation SKIPPED (Docker was not set up)."
        fi
        echo ""

    - name: Self-hosted runner validation
      id: runner
      shell: bash
      run: |
        echo ""
        echo "====================================== RUNNER VALIDATION ======================================="
        if [ "${{ inputs.self-hosted-runner }}" = "false" ]; then
          echo "âš ï¸ You are using GitHub Actions runners, not self-hosted runners."
          echo "âš ï¸ You have a limited quota depending on your plan. Check it here: https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/workflow-commands-for-github-actions"
        else
          echo "ðŸ”§ Validating self-hosted runner configurations..."

          if [ "${{ inputs.technology }}" = "node" ]; then
            echo "ðŸ”§ Validating Node.js configurations..."
            if command -v node > /dev/null; then
              echo "âœ… Node.js is installed. Version: $(node -v)"
            else
              echo "âŒ Node.js is not installed. Please install Node.js."
              echo "âŒ Node.js is not installed. Please install Node.js." >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          elif [ "${{ inputs.technology }}" = "python" ]; then
            echo "ðŸ”§ Validating Python configurations..."
            if command -v python > /dev/null; then
              echo "âœ… Python is installed. Version: $(python --version)"
            else
              echo "âŒ Python is not installed. Please install Python."
              echo "âŒ Python is not installed. Please install Python." >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          elif [ "${{ inputs.technology }}" = "java" ]; then
            echo "ðŸ”§ Validating Java configurations..."
            if command -v java > /dev/null; then
              echo "âœ… Java is installed. Version: $(java -version 2>&1 | head -n 1)"
            else
              echo "âŒ Java is not installed. Please install Java."
              echo "âŒ Java is not installed. Please install Java." >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "âŒ Technology not supported. Please choose node, python, or java."
            echo "âŒ Technology not supported. Please choose node, python, or java." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        fi
        echo ""

    # - name: Secrets validation
    #   id: deployment
    #   shell: bash
    #   run: |
    #     echo "ðŸ”§ Validating secrets..."
    #     if [ -z "${{ secrets.TEST_SECRET }}" ]; then
    #         echo "âŒ TEST_SECRET is not set. Please add the TEST_SECRET secret to your repository."
    #         exit 1
    #       else
    #         echo "âœ… TEST_SECRET is set."
    #       fi

    - name: Deployment validation
      id: deployment
      shell: bash
      run: |
        echo ""
        echo "====================================== DEPLOYMENT VALIDATION ======================================="
        echo ""

    - name: Check JQ installation
      if: ${{ inputs.self-hosted-runner == 'true' }}
      shell: bash
      run: |
        echo ""
        if ! command -v jq > /dev/null; then
          echo "âŒ jq is not installed. Trying to install jq..."
          set -e
          wget -O jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64
          chmod +x jq
          sudo mv jq /usr/local/bin
          echo "âœ… jq installed. Version: $(jq --version)"
        else
          echo "âœ… jq found. Version: $(jq --version)"
        fi

    - name: Generate JSON config string
      id: generate-config
      shell: bash
      run: |
        echo ""
        echo "====================================== WORKFLOW_CONFIG JSON PARSING ======================================="
        # Check if workflow_config.yml exists
        if [ ! -f workflow_config.yml ]; then
          echo "âŒ Error: workflow_config.yml not found. Add the provided workflow_config.yml file to your repository and retry."
          echo "âŒ Error: workflow_config.yml not found. Add the provided workflow_config.yml file to your repository and retry." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        echo "Reading and converting workflow_config.yml to JSON..."
        json=$(cat workflow_config.yml | awk -F'=' '{gsub(/"/, "", $2); printf "{\"%s\":\"%s\"}\n", $1, $2}' | jq -s 'add')
        echo $json > temp.json
        json=$(jq -r --compact-output '.' temp.json)
        echo "Your workflow configuration"
        cat temp.json
        echo "JSON=$json" >> $GITHUB_OUTPUT

    - name: Summary
      id: summary
      shell: bash
      run: |
        echo ""
        echo "====================================== WORKFLOW SUMMARY ======================================="
        echo "## Workflow information" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ All validations passed successfully! | Technology: ${{ inputs.technology }} | Docker enabled: ${{ inputs.docker }} | Self-hosted runners: ${{ inputs.self-hosted-runner }} | Deployment type: ${{ inputs.deployment }}"
        echo "ðŸŽ‰ All validations passed successfully! | Technology: ${{ inputs.technology }} | Docker enabled: ${{ inputs.docker }} | Self-hosted runners: ${{ inputs.self-hosted-runner }} | Deployment type: ${{ inputs.deployment }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ‘¤ Workflow (${{ github.workflow }}) triggered by: ${{ github.actor }} on ${{ github.repository }}"
        echo "ðŸ‘¤ Workflow (${{ github.workflow }}) triggered by: ${{ github.actor }} on ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”€ Branch: ${{ github.ref }}"
        echo "ðŸ”€ Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "âš¡ Trigger: ${{ github.event_name }}"
        echo "âš¡ Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ†” Workflow run ID: ${{ github.run_id }}"
        echo "ðŸ†” Workflow run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ•’ Execution time: $(date)"
        echo "ðŸ•’ Execution time: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "ðŸ”— Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "==============================================================================================="

    - name: Generate Workflow Summary Report Output
      id: generate-summary
      shell: bash
      run: |
        echo $GITHUB_STEP_SUMMARY
        # echo "VALIDATE_SUMMARY=$summary" >> $GITHUB_OUTPUT